---
title: "Práctica final Análisis de Datos: Ucinet"
author: "Castillo Millán, Sofía; Cirer Pastrana, Víctor Javier; Corporales Tur, Marta"
time:  "`Sys.Date()`"
output: 
  html_document: 
    keep_md: yes
    number_sections: yes
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)

# Cargamos librerías
library("tidyverse")
```

# Introducción

# Resumen

# Limpieza de datos

```{r path}
path = "data_basic_physionet/set-a/"# path training

lista_pacientes_set_a = dir(path) # lista  ficheros pacientes 

# length(lista_pacientes_set_a) # número pacientes en training
```


```{r cargarSetA}
# Lista path's a cada fichero de paciente
list_files = paste0(path, lista_pacientes_set_a)

# Función leer paciente
leer_paciente = function(file){
  read_csv(file, col_types = cols(Time = col_character(),
                                 Parameter = col_character(),
                                 Value = col_double())) %>%
    separate(Time, into = c("H","M"), sep = ":") %>% 
    mutate(Time_Minutes = as.numeric(H)*60 + as.numeric(M)) %>% 
    select(Time_Minutes, Parameter, Value)
}

# Leer_paciente(list_files[1])
raw_data = lapply(list_files,leer_paciente) # Lista de los datos por paciente

# Extraer perfiles "RecordID", "Age", "Gender", "Height", "Weight", "ICUType" 
perfil = function(data_paciente){
  data_paciente %>% 
    filter(Parameter %in% c("RecordID", "Age", "Gender", "Height", "ICUType", "Weight")) %>%
    select(-Time_Minutes) %>% distinct(Parameter, .keep_all = TRUE) %>% 
    spread(Parameter, Value)
}

# Guardamos los datos de perfil de cada paciente
perfiles = lapply(raw_data, perfil)%>%
  bind_rows() %>%
  select(RecordID, Age, Gender, Height, Weight, ICUType)

## Leer series
## Se modifica error de time
serie_UCI_parameter <- function(paciente,parameters){
  paciente %>%
    arrange(Parameter, Time_Minutes) %>%
    filter(Parameter %in% parameters) %>%
    add_column(RecordID = paciente[1,3]$Value) 
} 
```




```{r}
# Paso parámetros y apilo 
parameters = c("Albumin", "ALP", "ALT", "AST", "Bilirubin", "BUN", "Cholesterol", "Creatinine", "DiasABP", "FiO2", "GCS", "Glucose", "HCO3", "HCT", "HR", "K", "Lactate", "Mg", "MAP", "MechVent", "Na", "NIDiasABP", "NIMAP", "NISysABP", "PaCO2", "PaO2", "pH", "Platelets", "RespRate", "SaO2", "SysABP", "Temp", "TropI", "TropT", "Urine", "WBC")
series_parameters = lapply(raw_data, FUN = function(x) serie_UCI_parameter(x,parameters)) %>%
  bind_rows()
```


En resumen hasta ahora tenemos lo siguiente

```{r glimpse}
#set-a
glimpse(perfiles)
glimpse(series_parameters)
```


## Unificar: series, perfiles y scores

Nos faltan los scores clásicos que se utilizan eb las ICU. Estos ewstán el fichero Outcome-a.txt para el set-a


```{r}
scoresApath = "data_basic_physionet/Outcomes-a.txt"
scoresA = read_csv(scoresApath)
glimpse(scoresA)
Scores_perfilesA = inner_join(perfiles, scoresA, "RecordID")
glimpse(Scores_perfilesA)
```


### Extracción factores de las series 

Genero una tabla con resumenes de  las variables por paciente: media, desviación típica 

```{r}
series_summary = series_parameters %>%
  group_by(RecordID, Parameter) %>%
  summarise(count = n(), mean = mean(Value, na.rm = TRUE), sd = sd(Value, na.rm = TRUE))%>%
  gather(Stat, Value, count:sd) %>%
  ungroup() %>%
  transmute(RecordID, ParameterStat = paste0(Parameter, "_" ,Stat), Value) %>%
  spread(ParameterStat, Value)
```


```{r}
data_tidy=Scores_perfilesA %>%
  inner_join(series_summary)

head(data_tidy)
```


Para elegir las variables hemos dibujado todos los boxplots para saber cuáles eran más significativas. Nos hemos quedado con las más significativas y en caso de duda entre dos hemos cogido la que no estaba en ninguno de los índices SOFA o SAPS.

```{r, echo = FALSE}

data_tidy$`In-hospital_death` = factor(data_tidy$`In-hospital_death`, labels = c("0","1"))

data_tidy %>%
  filter(!is.na(GCS_mean)) %>% 
  filter(!is.na(`In-hospital_death`)) %>%
  ggplot(data = data_tidy, mapping = aes(x = `In-hospital_death`, y = GCS_mean)) +
  geom_boxplot() + 
  ylim(6,7)
t.test(`In-hospital_death`)
```


Nos quedamos con las siguientes 10 variables: 
 
1. GCS 
2. WBC  (NO - medias iguales)
3. RespRate (NO - medias iguales)
4. Albumin 
5. BUN (NO - medias iguales)
6. Cholesterol (NO - medis iguales)
7. PaO2
8. Glucose (NO - medias iguales)
9. HCO3 (SAPS)
10. Lactate (NO - medias iguales)

Una vez tenemos estas vamos a aplicar un t.test para saber si es significativa o no. Para ello necesitamos primero hacer un var.test, donde descubrimos si la variables son iguales o no para poderlo tener en cuenta en el t.test. 

(Var.test - H0 varianzas iguales; H1 alternativa: varianzas distintas -> p-value < 0.05 rechazamos H0)
(t.test - H0 medias igaules; H1 distitnas -> akjsfhlakjsdfhlkaj)
```
x=data_tidy$GCS_mean[data_tidy$`In-hospital_death`==0]
> y=data_tidy$GCS_mean[data_tidy$`In-hospital_death`==1]
> var.test(x,y)

	F test to compare two variances

data:  x and y
F = 0.61916, num df = 3386, denom df = 548, p-value = 5.949e-15
alternative hypothesis: true ratio of variances is not equal to 1
95 percent confidence interval:
 0.5432952 0.7014304
sample estimates:
ratio of variances 
         0.6191629 

> t.test(x,y,var.equal = FALSE,alternative="greater")

	Welch Two Sample t-test

data:  x and y
t = 13.96, df = 662.43, p-value < 2.2e-16
alternative hypothesis: true difference in means is greater than 0
95 percent confidence interval:
 2.116574      Inf
sample estimates:
mean of x mean of y 
11.938966  9.539243 
```


Por tanto, nos quedamos con las siguientes 4: (solo 4 porque dice irene que como las otras no son significativas le vamos a meter basura en el informe)
1. GCS
2. Albumin
3. PaO2
4. HCO3 


```{r}
data_final <- data_tidy %>%
  select(RecordID, Age, Gender, Weight, ICUType, `SAPS-I`, SOFA, Length_of_stay, Survival, `In-hospital_death`, GCS_mean, Albumin_mean, PaO2_mean, HCO3_mean)
```