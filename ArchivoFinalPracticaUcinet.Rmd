---
title: "Práctica final Análisis de Datos: Ucinet"
author: "Castillo Millán, Sofía; Cirer Pastrana, Víctor Javier; Corporales Tur, Marta"
time:  "`Sys.Date()`"
output: 
  html_document: 
    keep_md: yes
    number_sections: yes
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)

# Cargamos librerías
library("tidyverse")
```

# Introducción

# Resumen

# Limpieza de datos

```{r path}
path = "data_basic_physionet/set-a/"# path training

lista_pacientes_set_a = dir(path) # lista  ficheros pacientes 

# length(lista_pacientes_set_a) # número pacientes en training
```


```{r cargarSetA}
# Lista path's a cada fichero de paciente
list_files = paste0(path, lista_pacientes_set_a)

# Función leer paciente
leer_paciente = function(file){
  read_csv(file, col_types = cols(Time = col_character(),
                                 Parameter = col_character(),
                                 Value = col_double())) %>%
    separate(Time, into = c("H","M"), sep = ":") %>% 
    mutate(Time_Minutes = as.numeric(H)*60 + as.numeric(M)) %>% 
    select(Time_Minutes, Parameter, Value)
}

# Leer_paciente(list_files[1])
raw_data = lapply(list_files,leer_paciente) # Lista de los datos por paciente

# Extraer perfiles "RecordID", "Age", "Gender", "Height", "Weight", "ICUType" 
perfil = function(data_paciente){
  data_paciente %>% 
    filter(Parameter %in% c("RecordID", "Age", "Gender", "Height", "ICUType", "Weight")) %>%
    select(-Time_Minutes) %>% distinct(Parameter, .keep_all = TRUE) %>% 
    spread(Parameter, Value)
}

# Guardamos los datos de perfil de cada paciente
perfiles = lapply(raw_data, perfil)%>%
  bind_rows() %>%
  select(RecordID, Age, Gender, Height, Weight, ICUType)

## Leer series
## Se modifica error de time
serie_UCI_parameter <- function(paciente,parameters){
  paciente %>%
    arrange(Parameter, Time_Minutes) %>%
    filter(Parameter %in% parameters) %>%
    add_column(RecordID = paciente[1,3]$Value) 
} 
```




```{r}
# Paso parámetros y apilo 
parameters = c("Albumin", "ALP", "ALT", "AST", "Bilirubin", "BUN", "Cholesterol", "Creatinine", "DiasABP", "FiO2", "GCS", "Glucose", "HCO3", "HCT", "HR", "K", "Lactate", "Mg", "MAP", "MechVent", "Na", "NIDiasABP", "NIMAP", "NISysABP", "PaCO2", "PaO2", "pH", "Platelets", "RespRate", "SaO2", "SysABP", "Temp", "TropI", "TropT", "Urine", "WBC")
series_parameters = lapply(raw_data, FUN = function(x) serie_UCI_parameter(x,parameters)) %>%
  bind_rows()
```


En resumen hasta ahora tenemos lo siguiente

```{r glimpse}
#set-a
glimpse(perfiles)
glimpse(series_parameters)
```


## Unificar: series, perfiles y scores

Nos faltan los scores clásicos que se utilizan eb las ICU. Estos ewstán el fichero Outcome-a.txt para el set-a


```{r}
scoresApath = "data_basic_physionet/Outcomes-a.txt"
scoresA = read_csv(scoresApath)
glimpse(scoresA)
Scores_perfilesA = inner_join(perfiles, scoresA, "RecordID")
glimpse(Scores_perfilesA)
```


### Extracción factores de las series 

Genero una tabla con resumenes de  las variables por paciente: media, desviación típica 

```{r}
series_summary = series_parameters %>%
  group_by(RecordID, Parameter) %>%
  summarise(count = n(), mean = mean(Value, na.rm = TRUE), sd = sd(Value, na.rm = TRUE))%>%
  gather(Stat, Value, count:sd) %>%
  ungroup() %>%
  transmute(RecordID, ParameterStat = paste0(Parameter, "_" ,Stat), Value) %>%
  spread(ParameterStat, Value)
```


```{r}
data_tidy=Scores_perfilesA %>%
  inner_join(series_summary)

head(data_tidy)
```


Para elegir las variables hemos dibujado todos los boxplots para saber cuáles eran más significativas teniendo en cuenta la variable `In-hospital_death`. Nos hemos quedado con las más significativas y en caso de duda entre dos hemos cogido la que no estaba en ninguno de los índices SOFA o SAPS. Como ejemplo, mostramos el boxplot del índice `GCS`.

```{r, echo = FALSE}

data_tidy$`In-hospital_death` = factor(data_tidy$`In-hospital_death`, labels = c("0","1"))

data_tidy %>%
  filter(!is.na(GCS_mean)) %>% 
  filter(!is.na(`In-hospital_death`)) %>%
  ggplot(data = data_tidy, mapping = aes(x = `In-hospital_death`, y = GCS_mean)) +
  geom_boxplot() + 
  ylim(6,7)
t.test(`In-hospital_death`)
```


Nos quedamos con las siguientes 10 variables: 
 
1. GCS 
2. WBC  (NO - medias iguales)
3. RespRate (NO - medias iguales)
4. Albumin 
5. BUN (NO - medias iguales)
6. Cholesterol (NO - medis iguales)
7. PaO2
8. Glucose (NO - medias iguales)
9. HCO3 (SAPS)
10. Lactate (NO - medias iguales)

Una vez tenemos estas vamos a aplicar un `t.test` para saber si es significativa o no. Para ello necesitamos primero hacer un `var.test`, donde descubrimos si las varianzas son iguales o no para poderlo tener en cuenta en el `t.test`. Vamos a mostrar como hemos hecho una de las variables, el índice `GCS` del cual ya hemos visto el boxplot. Recordemos que si `In-hospital_death` es 0 el paciente vive y si es 1, muere en hospital.

Asignamos al valor `x` los valores de la variable a estudiar de los que sobreviven y al `y` los de los que mueren en el hospital, y aplicamos el `var.test` de las dos teniendo en cuenta que nuestra hipótesis nula HO es que las varianzas sean iguales y la hipótesis alternativa H1 es que sean distintas.
```{r}
x = data_tidy$GCS_mean[data_tidy$`In-hospital_death` == 0]
y = data_tidy$GCS_mean[data_tidy$`In-hospital_death` == 1]
var.test(x,y)
```

Una vez aplicaco el test de las varianzas nos fijamos en el valor del `p-valor`. Si este es menor que 0.05, rechazamos la hipótesis nula, por lo que podemos aplicar un `t.test` para varianzas distintas con H0 medias iguales y H1 medias distintas.
```{r}
t.test(x, y, var.equal = FALSE, alternative = "greater")
```

Como el `p-valor` es menor que 0.05, rechazamos la hipótesis nula, por lo que obtenemos que las medias son distintas. Como las medias son distintas para muerto o vivo, consideramos que la variable es significativa para el estudio y la seleccionamos. 

De las 10 variables previamente seleccionadas, las que nos hayan salido que tienen media distinta para supervivientes o muertos en la UCI son las que consideraremos para nuestro estudio final.


Por tanto, nos quedamos con las siguientes 4: (nos quedamos 4 en vez de 5, pues las otras nos han salido no significativas y así no estropeamos los datos que nos pueden dar más información)
1. GCS
2. Albumin
3. PaO2
4. HCO3 


```{r}
data_final <- data_tidy %>%
  select(RecordID, Age, Gender, Weight, ICUType, `SAPS-I`, SOFA, Length_of_stay, Survival, `In-hospital_death`, GCS_mean, Albumin_mean, PaO2_mean, HCO3_mean)
```


# Análisi Multivariado

Comparación de variables dos a dos
```{r}
library("GGally")
library("PerformanceAnalytics")
library("ggcorrplot")
library("aplpack")

nums = c(2:9,11:14) # quitamos el 1 que es el numero que indica el paciente y el 10 ('in-hospital_death') porque la hemos hecho no numérica para que fuera factor 0 o 1 para indicar "muerto" o no "muerto" y para las correlaciones da error
ggpairs(data_final[,nums])
chart.Correlation(data_final[nums], histogram=TRUE, pch=19)

```


Matriz de covarianza
```{r}
cov(data_final[, nums])
```

Matriz de correlación
```{r}
cor(data_final[, nums])
```



Cálculo de componentes
```{r}
library("factoextra")

data_final.acp = prcomp(!is.na(data_final[, nums]), scale = TRUE) #he probado varias maneras pero no me va, he puesto lo del !is.na() porque si no me dice que hay valores inexistentes y no calcula pero así el error que me da no lo entiendo
```

A partir del análisis de componentes principales pintamos los siguientes gráficos para ver mejor la relación de las variables. (NO SE PINTAN PORQUE LO OTRO NO SE HA CALCULADO)

```{r}
fviz_pca_ind(data_final.acp,
             col.ind = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE # Para evitar que el texto se solape
             )
```

```{r}
fviz_pca_var(data_final.acp,
             col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE
             )
``` 



Comprobación del ACP: (TAMPOCO SE PINTA POR LO MISMO)
```{r}
library("ggfortify")
autoplot(data_final.acp,
         data = data_final,
         colour = 'ICUType',
         loadings = TRUE,
         loadings.colour = 'blue',
         loadings.label = TRUE,
         loadings.label.size = 3
         )
```








